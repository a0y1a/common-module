@using System.Data.Entity

@{
    List<T_MenuCategory> menuCategories = null;

    menuCategories = CacheProvider.Instance.Get<List<T_MenuCategory>>("_Layout", () =>
    {
        using (KeKeSoftPlatformDbContext db = new KeKeSoftPlatformDbContext())
        {
            return db.MenuCategory.Include(m => m.Menus).Include(m => m.Children).ToList();
        }
    });
}

@*@functions {
        public static bool HasPermission(List<T_MenuCategory> menuCategories, MenuCategoryDetailData.MenuElement element)
        {
            if (new Identity[] { Identity.Admin, Identity.SuperAdmin, Identity.Developer }.Any(m => _User.Value.OwnIdentities.Contains(m)))
            {
                return true;
            }
            var menuIds = CacheProvider.Instance.Get<List<Guid>>("_Layout_menu_ids", () =>
            {
                using (KeKeSoftPlatformDbContext db = new KeKeSoftPlatformDbContext())
                {
                    return db.Authorize.Where(m => m.MenuAction.MenuActionCode == "view").Select(m => m.MenuAction.MenuId).ToList();
                }
            });

            switch (element.Type)
            {
                case MenuElementType.Category:
                    foreach (var item in menuCategories.Single(m => m.Id == element.Id).Menus)
                    {
                        var authorized = menuIds.Contains(item.Id);
                        if (authorized)
                        {
                            return true;
                        }
                    }
                    foreach (var item in menuCategories.Where(m => m.ParentId == element.Id).ToList())
                    {
                        var authorized = HasPermission(menuCategories, new MenuCategoryDetailData.MenuElement
                        {
                            Id = item.Id,
                            Name = item.Name,
                            SequenceNum = item.SequenceNum,
                            Type = MenuElementType.Category
                        });
                        if (authorized)
                        {
                            return true;
                        }
                    }
                    break;
                case MenuElementType.Menu:
                    return menuIds.Contains(element.Id);
                default:
                    break;
            }
            return false;
        }
    }

    @helper RenderMenu(List<T_MenuCategory> menuCategories, T_MenuCategory parentMenuCategory)
    {
        var elements = new List<MenuCategoryDetailData.MenuElement>();
        if (parentMenuCategory == null)
        {
            elements = menuCategories.Where(m => m.ParentId.HasValue == false).Select(m => new MenuCategoryDetailData.MenuElement
            {
                Id = m.Id,
                SequenceNum = m.SequenceNum,
                Type = MenuElementType.Category,
                Name = m.Name
            }).OrderBy(m => m.SequenceNum).ToList();
        }
        else
        {
            elements = parentMenuCategory.Menus.Select(m => new MenuCategoryDetailData.MenuElement
            {
                Id = m.Id,
                SequenceNum = m.SequenceNum,
                Type = MenuElementType.Menu,
                Url = m.Url,
                Name = m.Name
            }).Concat(parentMenuCategory.Children.Select(m => new MenuCategoryDetailData.MenuElement
            {
                Id = m.Id,
                SequenceNum = m.SequenceNum,
                Type = MenuElementType.Category,
                Name = m.Name
            })).OrderBy(m => m.SequenceNum).ToList();
        }


        foreach (var element in elements.Where(m => HasPermission(menuCategories, m)).ToList())
        {
            if (element.Type == MenuElementType.Menu)
            {
                <li><a href="@element.Url"><i class="fa fa-circle-o"></i> <span>@element.Name</span></a></li>
            }
            else
            {
                <li class="treeview">
                    <a href="#">
                        @if (parentMenuCategory == null)
                        {
                            <i class="fa fa-folder"></i> <span>@element.Name</span>
                        }
                        else
                        {
                            <i class="fa fa-list"></i> <span>@element.Name</span>
                        }
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        @RenderMenu(menuCategories, menuCategories.Single(m => m.Id == element.Id))
                    </ul>
                </li>
            }
        }
    }*@

@functions {
    public static string UrlWithKey(string url, Guid menuId, Guid categoryId)
    {
        if (url.Contains("?"))
        {
            return $"{url}&{Config.NAVIGATION_TOP_KEY}={categoryId}&{Config.NAVIGATION_ITEM_KEY}={menuId}";
        }
        return $"{url}?{Config.NAVIGATION_TOP_KEY}={categoryId}&{Config.NAVIGATION_ITEM_KEY}={menuId}";
    }
}
<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>@ViewBag.Title</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.6 -->
    <link rel="stylesheet" href="@Url.Content("~/Content/bootstrap.min.css")">
    <!-- Font Awesome -->
    <link href="http://cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Ionicons -->
    <link href="http://cdn.bootcss.com/ionicons/2.0.1/css/ionicons.min.css" rel="stylesheet">


    <link href="@Url.Content("~/Content/css/select2.min.css")" rel="stylesheet" />

    <!-- Theme style -->
    <link rel="stylesheet" href="@Url.Content("~/Content/AdminLTE.min.css")">
    <!-- AdminLTE Skins. We have chosen the skin-blue for this starter
          page. However, you can choose any other skin. Make sure you
          apply the skin class to the body tag so the changes take effect.
    -->
    <link rel="stylesheet" href="@Url.Content("~/Content/skins/skin-blue.min.css")">
    <link href="http://cdn.bootcss.com/jquery-confirm/3.0.3/jquery-confirm.min.css" rel="stylesheet">
    <link href="/Content/jquery.toast.min.css" rel="stylesheet" />
    <link href="@Url.Content("~/Content/Site.css")" rel="stylesheet" />
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!--导航相关主页-->
    <link href="/Theme/Home/1/css/css.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
        .pf-required {
            color:red;
        }
    </style>

    @RenderSection("head", false)
</head>
<body style="background:#ecf0f5;">
    <div class="h-top">
        <div class="logo_2 pull-left">
            <a href="/System/DaiKous" style="width:100%;height:100%;display:inline-block;color:#fff;padding-top:20px;">
                主页
            </a>
        </div>
        <div class="yhxx pull-right">
            <div class="pull-left">
                <p style="text-align: right; padding-right: 5px; color: #fff; height: 60px; line-height: 60px;">
                    <span id="localtime"></span>
                    <script src="/Theme/Home/1/js/time.js" type="text/javascript"></script>
                </p>
            </div>
            <div class="menu pull-left">
                <ul id="nav">
                    <li class="top1">
                        <a href="#" class="top_link">
                            <p>
                                <img src="/Theme/Home/1/images/yhm.jpg" /><span class="down">@_User.Value.Name</span>
                            </p>
                        </a>
                        <ul class="sub">
                            <li class="text-center"><a href="#">@_User.Value.Name</a></li>
                            <li class="tuichu"><a href="/system/logout">安全退出</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="h-content">
        <div class="con_left pull-left">
            <!--This is the first division of left-->
            @{
                var topId = Session[Config.NAVIGATION_TOP_KEY] == null ? menuCategories.First().Id : Session[Config.NAVIGATION_TOP_KEY] as Guid?;
                var itemId = Session[Config.NAVIGATION_ITEM_KEY] == null ? null : Session[Config.NAVIGATION_ITEM_KEY] as Guid?;
            }
            <div id="firstpane" class="menu_list">
                <!--Code for menu starts here-->
                @foreach (var top in menuCategories.OrderBy(m => m.SequenceNum))
                {
                    var category = new MenuCategoryDetailData.MenuElement
                    {
                        Id = top.Id,
                        Name = top.Name,
                        SequenceNum = top.SequenceNum,
                        Type = MenuElementType.Category
                    };
                    //if (HasPermission(menuCategories, category))
                    //{
                    <p class="menu_head"><b class="b1">@top.Name</b></p>
                    <div class="menu_body" style="display:@((topId == top.Id) ? "block" : "none")">
                        @foreach (var item in top.Menus.Where(m => m.IsUser == false).OrderBy(m => m.SequenceNum))
                        {
                            var menu = new MenuCategoryDetailData.MenuElement
                            {
                                Id = item.Id,
                                Name = item.Name,
                                SequenceNum = item.SequenceNum,
                                Type = MenuElementType.Menu,
                                Url = item.Url
                            };
                            //if (HasPermission(menuCategories, menu))
                            //{
                            <a href="@(UrlWithKey(menu.Url,menu.Id,category.Id))"><span>@item.Name</span></a>
                                @*}*@
                        }
                    </div>
                        @*}*@
                }
            </div>
            <!--Code for menu ends here-->
        </div>
        <div class="con_right pull-right" style="margin-top:-9px;">
            @*<div class="crumbread"><span class="glyphicon glyphicon-arrow-left" id="expand"></span> @ViewBag.Title</div>*@
            <div class="main" id="p_main" style="width:100%;margin-top:10px; color:#333333 !important;">
                <div class="container-fluid">
                    @RenderBody()
                </div>
            </div>
        </div>

        <div style="display:none;">
            <audio id="chatAudio">
                <source src="/Scripts/notification/qq_notification.mp3" type="audio/mpeg">
            </audio>
        </div>
    </div>

    <!-- ./wrapper -->
    <!-- REQUIRED JS SCRIPTS -->
    <!-- jQuery 2.2.3 -->
    <script src="/Scripts/jquery-2.2.3.min.js"></script>
    <!-- Bootstrap 3.3.6 -->
    <script type="text/javascript" src="@Url.Content("~/Scripts/bootstrap.min.js")"></script>
    <!-- AdminLTE App -->
    <script type="text/javascript" src="@Url.Content("~/Scripts/app.min.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/plugins/slimScroll/jquery.slimscroll.min.js")"></script>
    <script src="http://cdn.bootcss.com/jquery-confirm/3.0.3/jquery-confirm.min.js"></script>
    <script type="text/javascript" src="/Scripts/jconfirm.defaults.js"></script>
    <script type="text/javascript" src="/Scripts/jquery.toast.min.js"></script>
    <script type="text/javascript" src="/Scripts/jquery.validate.min.js"></script>
    <script type="text/javascript" src="/Scripts/jquery.validate.zh-CN.js"></script>
    <script type="text/javascript" src="/Scripts/jquery.validate.unobtrusive.min.js"></script>
    <script type="text/javascript" src="/Scripts/jquery.blockUI.js"></script>
    <script src="https://cdn.bootcss.com/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="@Url.Content("~/Scripts/select2.min.js")"></script>
    <script src="@Url.Content("~/Scripts/i18n/zh-CN.js")"></script>
    <script src="/Scripts/jquery.cookie-1.4.1.min.js"></script>
    <script type="text/javascript" src="/Scripts/util/util.js"></script>
    <script type="text/javascript" src="/Scripts/util/app.js"></script>
    <script src="/Scripts/notification/desktop-notify.js"></script>

    <!-- Optionally, you can add Slimscroll and FastClick plugins.
         Both of these plugins are recommended to enhance the
         user experience. Slimscroll is required when using the
         fixed layout. -->
    @if (ViewContext.TempData[AlertEntity.ALERT_ENTITY] != null)
    {
        var alertEntity = ViewContext.TempData[AlertEntity.ALERT_ENTITY] as AlertEntity;
        <script type="text/javascript">
            $(function () {
                $.toast({
                    text: "@alertEntity.Message", // Text that is to be shown in the toast
                    heading: '提示', // Optional heading to be shown on the toast
                    icon: '@(alertEntity.Type== AlertType.Success?"success":"error")', // Type of toast icon
                    position: 'top-center'
                });
            });
        </script>
    }

    <!-- 解决 blockUI 提示信息 message 中文乱码的问题 -->
    <script type="text/javascript">
        $.blockUI.defaults = {
            message: '<h1>请稍候...</h1>',
            css: {
                padding: 0,
                margin: 0,
                width: '30%',
                top: '40%',
                left: '35%',
                textAlign: 'center',
                color: '#000',
                border: '3px solid #aaa',
                backgroundColor: '#fff',
                cursor: 'wait'
            },
            overlayCSS: {
                backgroundColor: '#000',
                opacity: 0.6,
                cursor: 'wait'
            },
            showOverlay: true
        };
    </script>

    <!--通知客户存在状态为 银联处理中 的代扣 -->
    <script type="text/javascript">
        function showNotification() {
            setInterval(function () {
                $.post("/system/QueryDaiKou", { applyDate: ($.cookie("notification") || '') }, function (result) {
                    if (!result.isSuccess) {
                        return;
                    }
                    if ($.cookie("notification") && $.cookie("notification") >= result.data.ApplyDate) {
                        return;
                    }
                    notify.createNotification("代扣通知", {
                        body: "有等待处理的代扣信息",
                        icon: "/Images/desktop_notification.png",
                        renotify: true,
                        //silent: true,
                        tag: 'tag'
                    });

                    $.cookie('notification', result.data.ApplyDate, { path: "/" })
                    $('#chatAudio')[0].play(); //播放声音
                })
            }, 3000);
        }

        $(function () {
            //验证浏览器是否支持桌面通知
            if (notify.isSupported) {
                console.info("notify.isSupported: " + notify.isSupported)
                //验证浏览器是否允许桌面通知
                console.info("notify.permissionLevel(): " + notify.permissionLevel())
                if (notify.permissionLevel() == notify.PERMISSION_DEFAULT) {                //没有开启
                    //向用户请求桌面通知的权限
                    notify.requestPermission(function () {
                        showNotification();
                    });
                } else if (notify.permissionLevel() == notify.PERMISSION_GRANTED) {             //已经开启
                    showNotification();
                }
            }
        })
    </script>

    <!--导航相关-->
    <!--下啦-->
    <script src="/Theme/Home/1/js/stuHover.js" type="text/javascript"></script>
    <!--左侧导航-->
    <script type="text/javascript" src="/Theme/Home/1/js/dbdh.js"></script>

    @RenderSection("foot", false)
</body>
</html>
